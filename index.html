<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Japanese Translator & Suggestion</title>
    <style>
        /* Reset và base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            overflow-x: hidden;
            width: 100%;
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
        }

        /* Container chính */
        .container {
            max-width: 800px;
            width: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        /* Các section chung */
        .input-section, 
        .result-section, 
        .suggestions-section {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            width: 100%;
        }

        /* Tiêu đề */
        h1 {
            font-size: 1.8rem;
            margin: 0 0 15px;
            color: #e0e0e0;
            word-break: break-word;
        }

        h3 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #e0e0e0;
        }

        /* Phần nhập liệu */
        .textarea-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 10px;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #333;
            border-radius: 4px;
            background-color: #2d2d2d;
            color: #e0e0e0;
            font-size: 1rem;
            resize: vertical;
            min-height: 120px;
        }

        /* Các nút */
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            transition: background 0.2s ease;
        }

        button:hover {
            background: #3367d6;
        }

        button:active {
            background: #2a54b5;
        }

        .clear-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #ff4444;
            padding: 6px 12px;
            font-size: 0.8rem;
            width: auto;
        }

        .copy-btn {
            background: #555;
            padding: 6px 12px;
            font-size: 0.8rem;
            width: auto;
            margin-top: 5px;
        }

        /* Loading spinner */
        .loading {
            display: none;
            margin: 10px 0;
            text-align: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4285f4;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Kết quả dịch */
        .result {
            padding: 15px;
            background-color: #2d2d2d;
            border-radius: 4px;
            border-left: 4px solid #34c759;
        }

        /* Gợi ý */
        .suggestions {
            margin-top: 15px;
        }

        .suggestion-item {
            background-color: #3d3d3d;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s ease;
            word-break: break-word;
        }

        .suggestion-item:hover {
            background-color: #4d4d4d;
        }

        /* Văn bản đa ngôn ngữ */
        .japanese-text {
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 1.2em;
            line-height: 1.8em;
            margin-bottom: 10px;
            word-break: break-word;
        }

        .hiragana-text {
            font-size: 1em;
            line-height: 1.6em;
            margin-bottom: 10px;
            color: #b3b3ff;
            word-break: break-word;
        }

        .vietnamese-text {
            font-size: 1em;
            line-height: 1.4em;
            padding-left: 10px;
            border-left: 2px solid #34c759;
            margin-bottom: 15px;
            word-break: break-word;
        }

        .translation-pair {
            padding: 10px;
            margin-bottom: 10px;
            border-bottom: 1px dashed #444;
        }

        .translation-pair:last-child {
            border-bottom: none;
        }

        .lang-label {
            font-size: 0.8em;
            color: #999;
            margin-bottom: 5px;
            font-weight: bold;
        }

        /* Hiệu ứng mở rộng nội dung */
        .content {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 100px;
            transition: max-height 0.3s ease;
        }

        .content.expanded {
            display: block;
            -webkit-line-clamp: unset;
            max-height: 1000px;
        }

        .expand-btn {
            display: block;
            text-align: center;
            color: #4285f4;
            padding: 5px;
            cursor: pointer;
            font-size: 0.8em;
            user-select: none;
        }

        /* Responsive cho mobile */
        @media (max-width: 600px) {
            body {
                padding: 10px;
                touch-action: pan-y; /* Chỉ cho phép cuộn dọc */
            }

            .container {
                padding: 0;
                gap: 15px;
            }

            h1 {
                font-size: 1.5rem;
            }

            .input-section, 
            .result-section, 
            .suggestions-section {
                padding: 15px;
                border-radius: 6px;
            }

            textarea {
                padding: 10px;
                font-size: 1rem;
            }

            button {
                padding: 10px;
            }

            .japanese-text {
                font-size: 1.1em;
                line-height: 1.6em;
            }

            .hiragana-text {
                font-size: 0.9em;
                line-height: 1.4em;
            }

            .vietnamese-text {
                font-size: 0.9em;
                line-height: 1.3em;
            }
        }

        /* Ngăn chặn zoom trên mobile */
        @media (max-width: 480px) {
            textarea, button, .japanese-text, .vietnamese-text {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <section class="input-section">
            <h1>Japanese Translator & Suggestion</h1>
            <p>Nhập văn bản (tiếng Việt hoặc tiếng Nhật):</p>
            <div class="textarea-wrapper">
                <textarea id="inputText" rows="4" placeholder="Nhập nội dung cần dịch"></textarea>
                <button id="clearBtn" class="clear-btn">Xóa</button>
            </div>
            <button id="translateBtn">Dịch & Gợi ý</button>
            <div id="loading" class="loading">
                <div class="spinner"></div>
            </div>
        </section>
        
        <section class="result-section">
            <h3>Kết quả dịch:</h3>
            <div class="result">
                <div id="translationResults"></div>
            </div>
        </section>
        
        <section class="suggestions-section">
            <h3>Gợi ý câu tiếp theo:</h3>
            <div class="suggestions">
                <div id="suggestionList"></div>
            </div>
        </section>
    </div>

    <script>
        // Nhúng trực tiếp API key của bạn ở đây
        const GEMINI_API_KEY = "AIzaSyDjgTk4uZQUCpFH5Zt8ZgP2CW-jhmkLv8o";
        
        document.addEventListener('DOMContentLoaded', function() {
            // Xử lý nút dịch
            document.getElementById('translateBtn').addEventListener('click', async function() {
                const inputText = document.getElementById('inputText').value.trim();
                
                if (!inputText) {
                    alert('Vui lòng nhập văn bản cần dịch');
                    return;
                }
                
                document.getElementById('loading').style.display = 'block';
                document.getElementById('translationResults').innerHTML = '';
                document.getElementById('suggestionList').innerHTML = '';
                
                try {
                    const promptForTranslation = `Detect the language (Japanese or Vietnamese) of the following text and translate it to both languages. 
                    If the text is in Japanese, translate it to Vietnamese.
                    If the text is in Vietnamese, translate it to Japanese.
                    
                    Text to translate: "${inputText}"
                    
                    For Japanese text, please provide:
                    1. The Japanese text with kanji.
                    2. The hiragana reading for the entire text.
                    3. The Vietnamese translation.
                    
                    Format your response as:
                    Detected Language: [Japanese/Vietnamese]
                    Japanese (Kanji): [Japanese text with kanji]
                    Hiragana: [Hiragana reading]
                    Vietnamese: [Vietnamese translation]`;
                    
                    const translationResponse = await fetchFromGemini(GEMINI_API_KEY, promptForTranslation);
                    const translationResult = extractBothTranslations(translationResponse);
                    document.getElementById('translationResults').innerHTML = translationResult;
                    
                    setupCollapsible();
                    
                    const promptForSuggestions = `Based on this text and its translation:
                    Original: "${inputText}"
                    Translation results: ${translationResult}
                    
                    Suggest 3 possible sentences that the person might want to say next in this conversation.
                    Keep the suggestions in the same language as the original input.
                    Make the suggestions short and natural, as if continuing the conversation.
                    Format each suggestion on a new line with "Suggestion 1:", "Suggestion 2:", etc.`;
                    
                    const suggestionsResponse = await fetchFromGemini(GEMINI_API_KEY, promptForSuggestions);
                    const suggestions = extractSuggestions(suggestionsResponse);
                    displaySuggestions(suggestions);
                    
                } catch (error) {
                    console.error('Error:', error);
                    document.getElementById('translationResults').innerHTML = 
                        '<p class="vietnamese-text">Có lỗi xảy ra khi dịch. Vui lòng thử lại.</p>';
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            });
            
            // Xử lý nút xóa
            document.getElementById('clearBtn').addEventListener('click', () => {
                document.getElementById('inputText').value = '';
                document.getElementById('translationResults').innerHTML = '';
                document.getElementById('suggestionList').innerHTML = '';
            });
            
            // Xử lý chọn gợi ý
            document.getElementById('suggestionList').addEventListener('click', function(e) {
                if (e.target.classList.contains('suggestion-item')) {
                    document.getElementById('inputText').value = e.target.textContent;
                    document.getElementById('inputText').focus();
                }
            });
        });
        
        function setupCollapsible() {
            const textElements = document.querySelectorAll('.japanese-text, .hiragana-text, .vietnamese-text');
            
            textElements.forEach(element => {
                if (element.scrollHeight > element.clientHeight) {
                    element.classList.add('content');
                    
                    const expandBtn = document.createElement('div');
                    expandBtn.classList.add('expand-btn');
                    expandBtn.textContent = 'Hiển thị thêm...';
                    element.after(expandBtn);
                    
                    expandBtn.addEventListener('click', function() {
                        element.classList.toggle('expanded');
                        expandBtn.textContent = element.classList.contains('expanded') ? 'Thu gọn' : 'Hiển thị thêm...';
                    });
                }
            });

            // Xử lý nút sao chép
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    navigator.clipboard.writeText(btn.dataset.text)
                        .then(() => {
                            btn.textContent = 'Đã sao chép!';
                            setTimeout(() => btn.textContent = 'Sao chép', 2000);
                        })
                        .catch(err => {
                            console.error('Failed to copy:', err);
                            btn.textContent = 'Lỗi sao chép';
                        });
                });
            });
        }
        
        async function fetchFromGemini(apiKey, promptText) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: promptText }] }],
                    generationConfig: {
                        maxOutputTokens: 2000
                    }
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'API request failed');
            }
            
            const data = await response.json();
            return data;
        }
        
        function extractBothTranslations(responseData) {
            try {
                const text = responseData.candidates[0].content.parts[0].text;
                const detectedLanguageMatch = text.match(/Detected Language: (Japanese|Vietnamese)/i);
                const detectedLanguage = detectedLanguageMatch ? detectedLanguageMatch[1] : 'Unknown';
                const japaneseMatch = text.match(/Japanese \(Kanji\): ([\s\S]*?)(?=Hiragana:|$)/i);
                const hiraganaMatch = text.match(/Hiragana: ([\s\S]*?)(?=Vietnamese:|$)/i);
                const vietnameseMatch = text.match(/Vietnamese: ([\s\S]*?)(?=\n\n|$)/i);
                
                let japaneseText = japaneseMatch ? japaneseMatch[1].trim() : '';
                let hiraganaText = hiraganaMatch ? hiraganaMatch[1].trim() : '';
                let vietnameseText = vietnameseMatch ? vietnameseMatch[1].trim() : '';
                
                let resultHTML = `
                <div class="translation-pair">
                    <div class="lang-label">日本語 (Tiếng Nhật - Kanji):</div>
                    <div class="japanese-text">${japaneseText}</div>
                    <button class="copy-btn" data-text="${escapeHtml(japaneseText)}">Sao chép</button>
                    <div class="lang-label">ひらがな (Cách đọc Hiragana):</div>
                    <div class="hiragana-text">${hiraganaText}</div>
                    <button class="copy-btn" data-text="${escapeHtml(hiraganaText)}">Sao chép</button>
                    <div class="lang-label">Tiếng Việt:</div>
                    <div class="vietnamese-text">${vietnameseText}</div>
                    <button class="copy-btn" data-text="${escapeHtml(vietnameseText)}">Sao chép</button>
                </div>`;
                
                return resultHTML;
            } catch (error) {
                console.error('Error extracting translations:', error);
                return '<p class="vietnamese-text">Không thể trích xuất bản dịch. Vui lòng thử lại.</p>';
            }
        }
        
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        function extractSuggestions(responseData) {
            try {
                const text = responseData.candidates[0].content.parts[0].text;
                const suggestions = [];
                const regex = /Suggestion \d+: (.*?)(?:\n|$)/g;
                let match;
                
                while ((match = regex.exec(text)) !== null) {
                    if (match[1].trim()) {
                        suggestions.push(match[1].trim());
                    }
                }
                
                return suggestions.length > 0 ? suggestions : [
                    "Bạn có thể nói thêm về điều đó không?",
                    "Tôi hiểu rồi, cảm ơn bạn!",
                    "Bạn có câu hỏi nào khác không?"
                ];
            } catch (error) {
                console.error('Error extracting suggestions:', error);
                return [
                    "Xin lỗi, không thể tạo gợi ý",
                    "Vui lòng thử lại",
                    "Nhập câu hỏi khác của bạn"
                ];
            }
        }
        
        function displaySuggestions(suggestions) {
            const suggestionList = document.getElementById('suggestionList');
            suggestionList.innerHTML = '';
            
            suggestions.forEach((suggestion, index) => {
                const suggestionElem = document.createElement('div');
                suggestionElem.classList.add('suggestion-item');
                suggestionElem.textContent = suggestion;
                suggestionElem.setAttribute('role', 'button');
                suggestionElem.setAttribute('aria-label', `Gợi ý ${index + 1}: ${suggestion}`);
                suggestionList.appendChild(suggestionElem);
            });
        }
    </script>
</body>
</html>

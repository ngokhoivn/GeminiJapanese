<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Japanese Translator & Suggestion</title>
    <style>
        /* Reset và base styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            width: 100%;
            line-height: 1.5;
            -webkit-text-size-adjust: 100%;
            touch-action: manipulation;
            padding: 0;
            overflow-x: hidden;
        }

        /* Container chính */
        .container {
            max-width: 800px;
            width: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 0 auto;
            overflow-x: hidden;
        }

        /* Các section chung */
        .input-section, 
        .result-section, 
        .suggestions-section {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.4);
            width: 100%;
            border: 1px solid #333;
            overflow-x: hidden;
            word-wrap: break-word;
        }

        /* Tiêu đề */
        h1 {
            font-size: clamp(1.5rem, 4vw, 1.8rem);
            margin: 0 0 15px;
            color: #e0e0e0;
            word-break: break-word;
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
            overflow-wrap: break-word;
        }

        h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #e0e0e0;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }

        /* Phần nhập liệu */
        .textarea-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 15px;
            max-width: 100%;
        }

        textarea {
            width: 100%;
            max-width: 100%;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 6px;
            background-color: #252525;
            color: #e0e0e0;
            font-size: 1rem;
            resize: vertical;
            min-height: 140px;
            line-height: 1.6;
            touch-action: manipulation;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        textarea:focus {
            outline: none;
            border-color: #4285f4;
            -webkit-overflow-scrolling: touch;
        }

        /* Các nút */
        button {
            background: #4285f4;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            width: 100%;
            transition: all 0.2s ease;
            -webkit-user-select: none;
            user-select: none;
            font-weight: 500;
            margin-top: 5px;
        }

        button:hover {
            background: #3367d6;
            transform: translateY(-1px);
        }

        button:active {
            background: #2a54b5;
            transform: translateY(0);
        }

        .clear-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ff4444;
            padding: 8px 15px;
            font-size: 0.85rem;
            width: auto;
            margin: 0;
            max-width: calc(100% - 30px);
        }

        .copy-btn {
            background: #555;
            padding: 8px 15px;
            font-size: 0.85rem;
            width: auto;
            margin-top: 8px;
            display: inline-block;
        }

        /* Loading spinner */
        .loading {
            display: none;
            margin: 15px 0;
            text-align: center;
        }

        .spinner {
            border: 4px solid rgba(243, 243, 243, 0.2);
            border-top: 4px solid #4285f4;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Kết quả dịch */
        .result {
            padding: 15px;
            background-color: #252525;
            border-radius: 6px;
            border-left: 4px solid #34c759;
        }

        /* Gợi ý */
        .suggestions {
            margin-top: 15px;
        }

        .suggestion-item {
            background-color: #2d2d2d;
            padding: 14px;
            margin-bottom: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            word-break: break-word;
            border: 1px solid #3d3d3d;
        }

        .suggestion-item:hover {
            background-color: #383838;
            transform: translateX(2px);
        }

        /* Văn bản đa ngôn ngữ */
        .japanese-text {
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 1.2em;
            line-height: 1.8em;
            margin-bottom: 12px;
            word-break: break-word;
        }

        .hiragana-text {
            font-size: 1em;
            line-height: 1.6em;
            margin-bottom: 12px;
            color: #b3b3ff;
            word-break: break-word;
        }

        .vietnamese-text {
            font-size: 1em;
            line-height: 1.6em;
            padding-left: 12px;
            border-left: 3px solid #34c759;
            margin-bottom: 15px;
            word-break: break-word;
        }

        .translation-pair {
            padding: 12px 0;
            margin-bottom: 15px;
            border-bottom: 1px dashed #444;
        }

        .translation-pair:last-child {
            border-bottom: none;
        }

        .lang-label {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 8px;
            font-weight: bold;
            display: block;
        }

        /* Hiệu ứng mở rộng nội dung */
        .content {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            max-height: 100px;
            transition: max-height 0.3s ease;
        }

        .content.expanded {
            display: block;
            -webkit-line-clamp: unset;
            max-height: 1000px;
        }

        .expand-btn {
            display: block;
            text-align: center;
            color: #4285f4;
            padding: 8px;
            cursor: pointer;
            font-size: 0.85em;
            user-select: none;
            margin-top: 5px;
        }

        /* Responsive cho mobile */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 0;
                width: 100%;
                gap: 15px;
            }

            .input-section, 
            .result-section, 
            .suggestions-section {
                padding: 15px;
                border-radius: 0;
                border-left: none;
                border-right: none;
            }

            textarea {
                padding: 12px;
                min-height: 120px;
            }

            button {
                padding: 12px;
            }

            .clear-btn {
                top: 12px;
                right: 12px;
            }
        }

        /* Ngăn chặn zoom trên mobile */
        @media (max-width: 480px) {
            textarea, button {
                font-size: 16px !important;
            }
            
            .japanese-text {
                font-size: 1.1em;
            }
            
            .hiragana-text, .vietnamese-text {
                font-size: 0.95em;
            }
        }

        /* Đảm bảo hình ảnh và iframe không gây tràn */
        img, iframe {
            max-width: 100%;
            height: auto;
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <section class="input-section">
            <h1>Japanese Translator & Suggestion</h1>
            <p>Nhập văn bản (tiếng Việt hoặc tiếng Nhật):</p>
            <div class="textarea-wrapper">
                <textarea id="inputText" rows="4" placeholder="Nhập nội dung cần dịch..."></textarea>
                <button id="clearBtn" class="clear-btn">Xóa</button>
            </div>
            <button id="translateBtn">Dịch & Gợi ý</button>
            <div id="loading" class="loading">
                <div class="spinner"></div>
            </div>
        </section>
        
        <section class="result-section">
            <h3>Kết quả dịch:</h3>
            <div class="result">
                <div id="translationResults"></div>
            </div>
        </section>
        
        <section class="suggestions-section">
            <h3>Gợi ý câu tiếp theo:</h3>
            <div class="suggestions">
                <div id="suggestionList"></div>
            </div>
        </section>
    </div>

    <script>
        // Nhúng trực tiếp API key của bạn ở đây
        const GEMINI_API_KEY = "AIzaSyDjgTk4uZQUCpFH5Zt8ZgP2CW-jhmkLv8o";
        
        document.addEventListener('DOMContentLoaded', function() {
            const inputText = document.getElementById('inputText');
            const translateBtn = document.getElementById('translateBtn');
            const clearBtn = document.getElementById('clearBtn');
            const loadingElement = document.getElementById('loading');
            const translationResults = document.getElementById('translationResults');
            const suggestionList = document.getElementById('suggestionList');
            
            // Xử lý nút dịch
            translateBtn.addEventListener('click', async function() {
                const text = inputText.value.trim();
                
                if (!text) {
                    alert('Vui lòng nhập văn bản cần dịch');
                    return;
                }
                
                loadingElement.style.display = 'block';
                translationResults.innerHTML = '';
                suggestionList.innerHTML = '';
                
                try {
                    // Tạo prompt cho dịch thuật
                    const translationPrompt = `Hãy dịch văn bản sau giữa tiếng Nhật và tiếng Việt:
                    
                    Văn bản: "${text}"
                    
                    Yêu cầu:
                    1. Xác định ngôn ngữ nguồn (tiếng Nhật hoặc tiếng Việt)
                    2. Dịch sang ngôn ngữ còn lại
                    3. Nếu là tiếng Nhật, cung cấp thêm phiên âm hiragana
                    
                    Định dạng kết quả:
                    Ngôn ngữ nguồn: [Japanese/Vietnamese]
                    Tiếng Nhật (Kanji): [văn bản tiếng Nhật]
                    Hiragana: [phiên âm hiragana]
                    Tiếng Việt: [bản dịch tiếng Việt]`;
                    
                    const translationResponse = await fetchFromGemini(GEMINI_API_KEY, translationPrompt);
                    const translationResult = formatTranslationResult(translationResponse);
                    translationResults.innerHTML = translationResult;
                    
                    setupCollapsible();
                    
                    // Tạo prompt cho gợi ý
                    const suggestionsPrompt = `Dựa trên đoạn hội thoại sau, hãy đề xuất 3 câu tiếp theo phù hợp:
                    
                    Ngữ cảnh: "${text}"
                    
                    Yêu cầu:
                    - Đề xuất ngắn gọn, tự nhiên
                    - Giữ nguyên ngôn ngữ nguồn
                    - Đánh số từng đề xuất
                    
                    Định dạng:
                    1. [đề xuất 1]
                    2. [đề xuất 2]
                    3. [đề xuất 3]`;
                    
                    const suggestionsResponse = await fetchFromGemini(GEMINI_API_KEY, suggestionsPrompt);
                    const suggestions = extractSuggestions(suggestionsResponse);
                    displaySuggestions(suggestions);
                    
                } catch (error) {
                    console.error('Lỗi:', error);
                    translationResults.innerHTML = 
                        '<p class="vietnamese-text">Đã xảy ra lỗi khi dịch. Vui lòng thử lại sau.</p>';
                } finally {
                    loadingElement.style.display = 'none';
                }
            });
            
            // Xử lý nút xóa
            clearBtn.addEventListener('click', () => {
                inputText.value = '';
                translationResults.innerHTML = '';
                suggestionList.innerHTML = '';
                inputText.focus();
            });
            
            // Xử lý chọn gợi ý
            suggestionList.addEventListener('click', function(e) {
                if (e.target.classList.contains('suggestion-item')) {
                    inputText.value = e.target.textContent;
                    inputText.focus();
                }
            });
            
            // Cho phép nhấn Enter trong textarea mà không submit form
            inputText.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    translateBtn.click();
                }
            });
        });
        
        function setupCollapsible() {
            const textElements = document.querySelectorAll('.japanese-text, .hiragana-text, .vietnamese-text');
            
            textElements.forEach(element => {
                if (element.scrollHeight > element.clientHeight) {
                    element.classList.add('content');
                    
                    const expandBtn = document.createElement('div');
                    expandBtn.classList.add('expand-btn');
                    expandBtn.textContent = 'Hiển thị thêm...';
                    element.after(expandBtn);
                    
                    expandBtn.addEventListener('click', function() {
                        element.classList.toggle('expanded');
                        expandBtn.textContent = element.classList.contains('expanded') ? 'Thu gọn' : 'Hiển thị thêm...';
                    });
                }
            });

            // Xử lý nút sao chép
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    navigator.clipboard.writeText(btn.dataset.text)
                        .then(() => {
                            btn.textContent = 'Đã sao chép!';
                            setTimeout(() => btn.textContent = 'Sao chép', 2000);
                        })
                        .catch(err => {
                            console.error('Lỗi khi sao chép:', err);
                            btn.textContent = 'Lỗi sao chép';
                        });
                });
            });
        }
        
        async function fetchFromGemini(apiKey, promptText) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: promptText }] }],
                    generationConfig: {
                        maxOutputTokens: 2000,
                        temperature: 0.7
                    }
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || 'Lỗi kết nối API');
            }
            
            const data = await response.json();
            return data;
        }
        
        function formatTranslationResult(responseData) {
            try {
                const text = responseData.candidates[0].content.parts[0].text;
                
                // Phân tích kết quả từ API
                const detectedLangMatch = text.match(/Ngôn ngữ nguồn:\s*(Japanese|Vietnamese)/i);
                const japaneseMatch = text.match(/Tiếng Nhật \(Kanji\):\s*([\s\S]*?)(?=Hiragana:|$)/i);
                const hiraganaMatch = text.match(/Hiragana:\s*([\s\S]*?)(?=Tiếng Việt:|$)/i);
                const vietnameseMatch = text.match(/Tiếng Việt:\s*([\s\S]*?)(?=\n\n|$)/i);
                
                const japaneseText = japaneseMatch ? japaneseMatch[1].trim() : '';
                const hiraganaText = hiraganaMatch ? hiraganaMatch[1].trim() : '';
                const vietnameseText = vietnameseMatch ? vietnameseMatch[1].trim() : '';
                const detectedLang = detectedLangMatch ? detectedLangMatch[1] : 'Unknown';
                
                // Tạo HTML kết quả
                return `
                <div class="translation-pair">
                    <div class="lang-label">Ngôn ngữ nguồn: ${detectedLang}</div>
                    <div class="lang-label">日本語 (Tiếng Nhật - Kanji):</div>
                    <div class="japanese-text">${japaneseText || 'Không có dữ liệu'}</div>
                    ${japaneseText ? `<button class="copy-btn" data-text="${escapeHtml(japaneseText)}">Sao chép</button>` : ''}
                    
                    <div class="lang-label">ひらがな (Cách đọc Hiragana):</div>
                    <div class="hiragana-text">${hiraganaText || 'Không có phiên âm'}</div>
                    ${hiraganaText ? `<button class="copy-btn" data-text="${escapeHtml(hiraganaText)}">Sao chép</button>` : ''}
                    
                    <div class="lang-label">Tiếng Việt:</div>
                    <div class="vietnamese-text">${vietnameseText || 'Không có bản dịch'}</div>
                    ${vietnameseText ? `<button class="copy-btn" data-text="${escapeHtml(vietnameseText)}">Sao chép</button>` : ''}
                </div>`;
            } catch (error) {
                console.error('Lỗi xử lý bản dịch:', error);
                return '<p class="vietnamese-text">Không thể phân tích kết quả dịch. Vui lòng thử lại.</p>';
            }
        }
        
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        function extractSuggestions(responseData) {
            try {
                const text = responseData.candidates[0].content.parts[0].text;
                const suggestions = [];
                const regex = /^\d+\.\s*(.*)$/gm;
                let match;
                
                while ((match = regex.exec(text)) !== null && suggestions.length < 3) {
                    if (match[1].trim()) {
                        suggestions.push(match[1].trim());
                    }
                }
                
                return suggestions.length > 0 ? suggestions : [
                    "Bạn có thể giải thích rõ hơn không?",
                    "Cảm ơn bạn đã giải thích",
                    "Tôi muốn biết thêm về điều này"
                ];
            } catch (error) {
                console.error('Lỗi xử lý gợi ý:', error);
                return [
                    "Xin lỗi, không thể tạo gợi ý",
                    "Vui lòng thử lại sau",
                    "Nhập nội dung khác để tiếp tục"
                ];
            }
        }
        
        function displaySuggestions(suggestions) {
            const suggestionList = document.getElementById('suggestionList');
            suggestionList.innerHTML = '';
            
            suggestions.forEach((suggestion, index) => {
                const suggestionElem = document.createElement('div');
                suggestionElem.classList.add('suggestion-item');
                suggestionElem.textContent = suggestion;
                suggestionElem.setAttribute('role', 'button');
                suggestionElem.setAttribute('tabindex', '0');
                suggestionElem.setAttribute('aria-label', `Gợi ý ${index + 1}: ${suggestion}`);
                suggestionList.appendChild(suggestionElem);
            });
        }
    </script>
</body>
</html>
